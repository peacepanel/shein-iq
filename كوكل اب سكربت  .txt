// ===== Google Apps Script - Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù…ØªÙƒØ§Ù…Ù„ Ø§Ù„ÙƒØ§Ù…Ù„ Ù„Ø´ÙŠ Ø§Ù† Ø§Ù„Ø¹Ø±Ø§Ù‚ =====
// Ø§Ù„Ø¥ØµØ¯Ø§Ø± 2.1 - Ù…Ø­Ø¯Ø« Ù„Ø¯Ø¹Ù… Ø¬Ø¯ÙˆÙ„ ÙˆØ§Ø­Ø¯ Ø¨Ù€ 5 Ø£ÙˆØ±Ø§Ù‚ Ø¹Ù…Ù„ + Ù†Ø¸Ø§Ù… Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ø­ØªØ±Ø§ÙÙŠ

// ===== Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…ÙˆØ­Ø¯Ø© Ø§Ù„Ù…ÙØ­Ø¯Ø«Ø© =====
const SYSTEM_CONFIG = {
  // Ù…Ø¹Ø±Ù Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„ÙˆØ§Ø­Ø¯ Ø§Ù„Ø°ÙŠ ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø¬Ù…ÙŠØ¹ Ø£ÙˆØ±Ø§Ù‚ Ø§Ù„Ø¹Ù…Ù„
  MAIN_SHEET_ID: '1ap6gkoczUsqvf0KMoxXroo2uP_wycDGxyg6r-UPFgBQ',
  
  // Ø£Ø³Ù…Ø§Ø¡ Ø£ÙˆØ±Ø§Ù‚ Ø§Ù„Ø¹Ù…Ù„
  SHEETS: {
    USERS: 'Users',
    ORDERS: 'Orders', 
    ANALYTICS: 'Analytics',
    SUBSCRIPTIONS: 'Subscriptions',
    NOTIFICATIONS: 'Notifications'
  },
  
  // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
  WEB_APP_URL: 'https://script.google.com/macros/s/AKfycbzc9ojokNkOcmtINeXR9ijzc5HCfq5Ljgcp_4WIpW5JLGSnJryRvnyZqH8EEwB7tbHk/exec',
  APP_URL: 'https://peacepanel.github.io/shein-baghdad/',
  NOTIFICATION_ICON: 'https://peacepanel.github.io/shein-baghdad/icons/icon-192x192.png',
  WHATSAPP_NUMBER: '9647862799748',
  
  // Firebase Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
  FIREBASE_ENABLED: false, // Ø³ÙŠØªÙ… ØªÙØ¹ÙŠÙ„Ù‡ Ù„Ø§Ø­Ù‚Ø§Ù‹
  FIREBASE_SERVER_KEY: 'Ø³ÙŠØªÙ…_ØªØ­Ø¯ÙŠØ«Ù‡_Ø¹Ù†Ø¯_Ø¥Ø¹Ø¯Ø§Ø¯_Firebase',
  FCM_ENDPOINT: 'https://fcm.googleapis.com/fcm/send',
  
  // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù…
  SYSTEM_VERSION: '2.1.0',
  LAST_UPDATED: '2025-01-27',
  TIMEZONE: 'Asia/Baghdad'
};

// ===== Ø¯ÙˆØ§Ù„ Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ù„ÙˆØµÙˆÙ„ Ù„Ø£ÙˆØ±Ø§Ù‚ Ø§Ù„Ø¹Ù…Ù„ =====

function getSheet(sheetName) {
  try {
    const spreadsheet = SpreadsheetApp.openById(SYSTEM_CONFIG.MAIN_SHEET_ID);
    let sheet = spreadsheet.getSheetByName(sheetName);
    
    if (!sheet) {
      console.log(`Ø¥Ù†Ø´Ø§Ø¡ ÙˆØ±Ù‚Ø© Ø¹Ù…Ù„ Ø¬Ø¯ÙŠØ¯Ø©: ${sheetName}`);
      sheet = spreadsheet.insertSheet(sheetName);
      initializeSheet(sheet, sheetName);
    }
    
    return sheet;
  } catch (error) {
    console.error(`Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ÙˆØµÙˆÙ„ Ù„ÙˆØ±Ù‚Ø© Ø§Ù„Ø¹Ù…Ù„ ${sheetName}:`, error);
    throw error;
  }
}

function initializeSheet(sheet, sheetName) {
  console.log(`ØªÙ‡ÙŠØ¦Ø© ÙˆØ±Ù‚Ø© Ø§Ù„Ø¹Ù…Ù„: ${sheetName}`);
  
  const headers = getSheetHeaders(sheetName);
  if (headers.length > 0) {
    sheet.getRange(1, 1, 1, headers.length).setValues([headers]);
    
    // ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø¹Ù†Ø§ÙˆÙŠÙ†
    const headerRange = sheet.getRange(1, 1, 1, headers.length);
    headerRange.setBackground('#8B5CF6');
    headerRange.setFontColor('white');
    headerRange.setFontWeight('bold');
    headerRange.setFontSize(12);
  }
}

function getSheetHeaders(sheetName) {
  const headerMap = {
    [SYSTEM_CONFIG.SHEETS.USERS]: [
      'Ø§Ù„ØªØ§Ø±ÙŠØ®', 'Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…', 'Ø§Ù„Ø§Ø³Ù…', 'Ø§Ù„Ù‡Ø§ØªÙ', 'Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø©', 
      'Ø§Ù„Ø¹Ù†ÙˆØ§Ù†', 'Ø§Ù„Ø¬Ù†Ø³', 'Ø§Ù„Ø§Ù‡ØªÙ…Ø§Ù…Ø§Øª', 'Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª', 'ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ³Ø¬ÙŠÙ„', 
      'Ø¢Ø®Ø± Ù†Ø´Ø§Ø·', 'Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¬Ù‡Ø§Ø²', 'Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…'
    ],
    [SYSTEM_CONFIG.SHEETS.ORDERS]: [
      'Ø§Ù„ØªØ§Ø±ÙŠØ®', 'Ù…Ø¹Ø±Ù Ø§Ù„Ø·Ù„Ø¨', 'Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…', 'Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„', 
      'Ø§Ù„Ù‡Ø§ØªÙ', 'Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø©', 'Ø§Ù„Ø¹Ù†ÙˆØ§Ù†', 'Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª', 'Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ÙØ±Ø¹ÙŠ',
      'Ø±Ø³ÙˆÙ… Ø§Ù„ØªÙˆØµÙŠÙ„', 'Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ÙƒÙ„ÙŠ', 'Ø§Ù„Ø­Ø§Ù„Ø©', 'ÙˆÙ‚Øª Ø§Ù„Ø·Ù„Ø¨', 'Ù…Ù„Ø§Ø­Ø¸Ø§Øª'
    ],
    [SYSTEM_CONFIG.SHEETS.ANALYTICS]: [
      'Ø§Ù„ØªØ§Ø±ÙŠØ®', 'Ù†ÙˆØ¹ Ø§Ù„Ø­Ø¯Ø«', 'Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…', 'Ø§Ù„ØªÙØ§ØµÙŠÙ„', 
      'Ø§Ù„Ù…ØµØ¯Ø±', 'Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©', 'Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø©', 'Ø§Ù„Ø¬Ù‡Ø§Ø²'
    ],
    [SYSTEM_CONFIG.SHEETS.SUBSCRIPTIONS]: [
      'Ø§Ù„ØªØ§Ø±ÙŠØ®', 'Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…', 'Ø§Ù„Ø§Ø³Ù…', 'Ø§Ù„Ù‡Ø§ØªÙ', 'Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø©',
      'Ù†ÙˆØ¹ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ', 'Ø§Ù„Ø§Ù‡ØªÙ…Ø§Ù…Ø§Øª', 'ØªÙˆÙ‚ÙŠØª Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª', 'Ø­Ø§Ù„Ø© Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ', 
      'ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ', 'Ø¢Ø®Ø± Ø¥Ø´Ø¹Ø§Ø±', 'Firebase Token'
    ],
    [SYSTEM_CONFIG.SHEETS.NOTIFICATIONS]: [
      'Ø§Ù„ØªØ§Ø±ÙŠØ®', 'Ù…Ø¹Ø±Ù Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±', 'Ø§Ù„Ø¹Ù†ÙˆØ§Ù†', 'Ø§Ù„Ù…Ø­ØªÙˆÙ‰', 'Ø§Ù„Ù†ÙˆØ¹',
      'Ø§Ù„Ø¬Ù…Ù‡ÙˆØ± Ø§Ù„Ù…Ø³ØªÙ‡Ø¯Ù', 'Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø© Ø§Ù„Ù…Ø³ØªÙ‡Ø¯ÙØ©', 'Ø§Ù„Ø§Ù‡ØªÙ…Ø§Ù…Ø§Øª Ø§Ù„Ù…Ø³ØªÙ‡Ø¯ÙØ©',
      'ÙˆÙ‚Øª Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù…Ø¬Ø¯ÙˆÙ„', 'Ø§Ù„Ø­Ø§Ù„Ø©', 'Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø±Ø³Ù„ Ø¥Ù„ÙŠÙ‡Ù…', 'Ù…Ø¹Ø¯Ù„ Ø§Ù„Ù†Ø¬Ø§Ø­',
      'ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡', 'Ù…Ù†Ø´Ø¦ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±', 'ØµÙˆØ±Ø© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±', 'Ø±Ø§Ø¨Ø· Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡'
    ]
  };
  
  return headerMap[sheetName] || [];
}

// ===== 1. Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ù…ÙØ­Ø¯Ø«Ø© =====

function saveUserData(userData) {
  try {
    if (!userData || !userData.id || !userData.name || !userData.phone) {
      return { 
        success: false, 
        error: 'Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù†Ø§Ù‚ØµØ©',
        required: ['id', 'name', 'phone']
      };
    }
    
    const sheet = getSheet(SYSTEM_CONFIG.SHEETS.USERS);
    
    // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯
    const data = sheet.getDataRange().getValues();
    let userRow = -1;
    
    for (let i = 1; i < data.length; i++) {
      if (data[i][1] === userData.id) {
        userRow = i + 1;
        break;
      }
    }
    
    const rowData = [
      new Date(),
      userData.id,
      userData.name,
      userData.phone,
      userData.governorate || '',
      userData.address || '',
      userData.gender || '',
      Array.isArray(userData.interests) ? userData.interests.join(',') : (userData.interests || ''),
      userData.notificationsEnabled || false,
      userData.registrationDate || new Date().toISOString(),
      userData.lastActive || new Date().toISOString(),
      JSON.stringify(userData.deviceInfo || {}),
      'active'
    ];
    
    const isNewUser = userRow === -1;
    
    if (userRow > 0) {
      sheet.getRange(userRow, 1, 1, rowData.length).setValues([rowData]);
      console.log('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:', userData.id);
    } else {
      sheet.appendRow(rowData);
      console.log('ØªÙ… Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯:', userData.id);
      
      // Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ø§Ø´ØªØ±Ø§ÙƒØ§Øª Ø¥Ø°Ø§ ÙƒØ§Ù† Ø¬Ø¯ÙŠØ¯
      if (userData.notificationsEnabled) {
        addUserToSubscriptions(userData);
      }
    }
    
    // ØªØªØ¨Ø¹ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
    trackUserEvent(userData.id, isNewUser ? 'user_registered' : 'user_updated', {
      name: userData.name,
      governorate: userData.governorate,
      interests: userData.interests
    });
    
    // Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± ØªØ±Ø­ÙŠØ¨ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ø¬Ø¯Ø¯
    if (isNewUser && userData.notificationsEnabled) {
      scheduleWelcomeNotification(userData);
    }
    
    return { 
      success: true, 
      userId: userData.id,
      action: isNewUser ? 'created' : 'updated',
      message: 'ØªÙ… Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ù†Ø¬Ø§Ø­',
      isNewUser: isNewUser
    };
    
  } catch (error) {
    console.error('Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:', error);
    return { 
      success: false, 
      error: error.toString(),
      message: 'ÙØ´Ù„ ÙÙŠ Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…'
    };
  }
}

function getUserById(userId) {
  try {
    const sheet = getSheet(SYSTEM_CONFIG.SHEETS.USERS);
    const data = sheet.getDataRange().getValues();
    
    for (let i = 1; i < data.length; i++) {
      if (data[i][1] === userId) {
        return {
          id: data[i][1],
          name: data[i][2],
          phone: data[i][3],
          governorate: data[i][4],
          address: data[i][5],
          gender: data[i][6],
          interests: data[i][7] ? data[i][7].split(',') : [],
          notificationsEnabled: data[i][8],
          registrationDate: data[i][9],
          lastActive: data[i][10],
          status: data[i][12] || 'active'
        };
      }
    }
    
    return null;
  } catch (error) {
    console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:', error);
    return null;
  }
}

function getAllActiveUsers() {
  try {
    const sheet = getSheet(SYSTEM_CONFIG.SHEETS.USERS);
    const data = sheet.getDataRange().getValues();
    const users = [];
    
    for (let i = 1; i < data.length; i++) {
      const row = data[i];
      if (row[8] === true && row[1] && (row[12] === 'active' || !row[12])) {
        users.push({
          id: row[1],
          name: row[2] || 'Ù…Ø³ØªØ®Ø¯Ù…',
          phone: row[3] || '',
          governorate: row[4] || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯',
          interests: row[7] ? row[7].split(',').map(i => i.trim()) : [],
          registrationDate: row[9],
          lastActive: row[10]
        });
      }
    }
    
    return users;
  } catch (error) {
    console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ù†Ø´Ø·ÙŠÙ†:', error);
    return [];
  }
}

// ===== 2. Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø§Ø´ØªØ±Ø§ÙƒØ§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© =====

function addUserToSubscriptions(userData) {
  try {
    const sheet = getSheet(SYSTEM_CONFIG.SHEETS.SUBSCRIPTIONS);
    
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ
    const data = sheet.getDataRange().getValues();
    for (let i = 1; i < data.length; i++) {
      if (data[i][1] === userData.id) {
        console.log('Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø´ØªØ±Ùƒ Ø¨Ø§Ù„ÙØ¹Ù„:', userData.id);
        return { success: true, action: 'already_subscribed' };
      }
    }
    
    const rowData = [
      new Date(),
      userData.id,
      userData.name,
      userData.phone,
      userData.governorate || '',
      'general', // Ù†ÙˆØ¹ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ
      Array.isArray(userData.interests) ? userData.interests.join(',') : (userData.interests || ''),
      'all_times', // ØªÙˆÙ‚ÙŠØª Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
      'active',
      new Date().toISOString(),
      '', // Ø¢Ø®Ø± Ø¥Ø´Ø¹Ø§Ø±
      '' // Firebase Token
    ];
    
    sheet.appendRow(rowData);
    console.log('ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ø´ØªØ±Ø§Ùƒ Ø¬Ø¯ÙŠØ¯:', userData.id);
    
    return { success: true, action: 'subscribed' };
    
  } catch (error) {
    console.error('Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ:', error);
    return { success: false, error: error.toString() };
  }
}

function getSubscribedUsers(filters = {}) {
  try {
    const sheet = getSheet(SYSTEM_CONFIG.SHEETS.SUBSCRIPTIONS);
    const data = sheet.getDataRange().getValues();
    const subscribers = [];
    
    for (let i = 1; i < data.length; i++) {
      const row = data[i];
      if (row[8] === 'active' && row[1]) { // Ø­Ø§Ù„Ø© Ù†Ø´Ø·Ø© ÙˆÙ…Ø¹Ø±Ù Ù…ÙˆØ¬ÙˆØ¯
        const subscriber = {
          id: row[1],
          name: row[2] || 'Ù…Ø³ØªØ®Ø¯Ù…',
          phone: row[3] || '',
          governorate: row[4] || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯',
          subscriptionType: row[5] || 'general',
          interests: row[6] ? row[6].split(',').map(i => i.trim()) : [],
          notificationTiming: row[7] || 'all_times',
          subscriptionDate: row[9],
          lastNotification: row[10],
          firebaseToken: row[11]
        };
        
        // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙÙ„Ø§ØªØ±
        let includeUser = true;
        
        if (filters.governorate && subscriber.governorate !== filters.governorate) {
          includeUser = false;
        }
        
        if (filters.interest && !subscriber.interests.includes(filters.interest)) {
          includeUser = false;
        }
        
        if (filters.subscriptionType && subscriber.subscriptionType !== filters.subscriptionType) {
          includeUser = false;
        }
        
        if (includeUser) {
          subscribers.push(subscriber);
        }
      }
    }
    
    return subscribers;
  } catch (error) {
    console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø´ØªØ±ÙƒÙŠÙ†:', error);
    return [];
  }
}

// ===== 3. Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…ÙØ­Ø¯Ø«Ø© =====

function saveOrderData(orderData) {
  try {
    if (!orderData || !orderData.userId) {
      return { 
        success: false, 
        error: 'Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø¨ Ù†Ø§Ù‚ØµØ©',
        required: ['userId']
      };
    }
    
    const sheet = getSheet(SYSTEM_CONFIG.SHEETS.ORDERS);
    const orderId = `SHIQ-${Date.now()}-${orderData.userId.slice(-4)}`;
    
    const rowData = [
      new Date(),
      orderId,
      orderData.userId,
      orderData.userName || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯',
      orderData.userPhone || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯',
      orderData.governorate || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯',
      orderData.address || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯',
      JSON.stringify(orderData.products || []),
      orderData.subtotal || 0,
      orderData.deliveryFee || 0,
      orderData.total || 0,
      orderData.status || 'pending',
      orderData.orderDate || new Date().toISOString(),
      orderData.notes || ''
    ];
    
    sheet.appendRow(rowData);
    console.log('ØªÙ… Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø¨:', orderId);
    
    // ØªØªØ¨Ø¹ Ø§Ù„Ø·Ù„Ø¨
    trackUserEvent(orderData.userId, 'order_placed', {
      orderId: orderId,
      total: orderData.total,
      products: orderData.products?.length || 0,
      governorate: orderData.governorate
    }, orderData.governorate);
    
    // Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„Ø¬Ø¯ÙŠØ¯ (Ø³ÙŠØªÙ… Ø¥Ø±Ø³Ø§Ù„Ù‡ Ù„Ù„Ø¥Ø¯Ø§Ø±Ø©)
    scheduleOrderNotification(orderId, orderData);
    
    return { 
      success: true, 
      orderId: orderId,
      total: orderData.total,
      message: 'ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø·Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­'
    };
    
  } catch (error) {
    console.error('Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø¨:', error);
    return { 
      success: false, 
      error: error.toString(),
      message: 'ÙØ´Ù„ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø·Ù„Ø¨'
    };
  }
}

// ===== 4. Ù†Ø¸Ø§Ù… Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠ Ø§Ù„Ø¬Ø¯ÙŠØ¯ =====

function createNotification(notificationData) {
  try {
    if (!notificationData.title || !notificationData.body) {
      return { 
        success: false, 
        error: 'Ø¹Ù†ÙˆØ§Ù† ÙˆÙ…Ø­ØªÙˆÙ‰ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± Ù…Ø·Ù„ÙˆØ¨Ø§Ù†'
      };
    }
    
    const sheet = getSheet(SYSTEM_CONFIG.SHEETS.NOTIFICATIONS);
    const notificationId = `notif_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
    
    const rowData = [
      new Date(),
      notificationId,
      notificationData.title,
      notificationData.body,
      notificationData.type || 'general',
      notificationData.audience || 'all',
      notificationData.targetGovernorate || '',
      notificationData.targetInterests || '',
      notificationData.scheduledTime || '',
      'created',
      0, // Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø±Ø³Ù„ Ø¥Ù„ÙŠÙ‡Ù…
      '0%', // Ù…Ø¹Ø¯Ù„ Ø§Ù„Ù†Ø¬Ø§Ø­
      new Date().toISOString(),
      notificationData.creator || 'system',
      notificationData.image || '',
      notificationData.actionUrl || SYSTEM_CONFIG.APP_URL
    ];
    
    sheet.appendRow(rowData);
    console.log('ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø¥Ø´Ø¹Ø§Ø± Ø¬Ø¯ÙŠØ¯:', notificationId);
    
    // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± ÙÙˆØ±ÙŠØ§Ù‹ØŒ Ø£Ø±Ø³Ù„Ù‡ Ø§Ù„Ø¢Ù†
    if (!notificationData.scheduledTime || notificationData.scheduledTime === 'now') {
      return sendNotificationById(notificationId);
    }
    
    return { 
      success: true, 
      notificationId: notificationId,
      message: 'ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± Ø¨Ù†Ø¬Ø§Ø­',
      scheduled: !!notificationData.scheduledTime
    };
    
  } catch (error) {
    console.error('Ø®Ø·Ø£ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±:', error);
    return { 
      success: false, 
      error: error.toString(),
      message: 'ÙØ´Ù„ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±'
    };
  }
}

function sendNotificationById(notificationId) {
  try {
    const sheet = getSheet(SYSTEM_CONFIG.SHEETS.NOTIFICATIONS);
    const data = sheet.getDataRange().getValues();
    let notificationRow = -1;
    let notification = null;
    
    // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±
    for (let i = 1; i < data.length; i++) {
      if (data[i][1] === notificationId) {
        notificationRow = i + 1;
        notification = {
          id: data[i][1],
          title: data[i][2],
          body: data[i][3],
          type: data[i][4],
          audience: data[i][5],
          targetGovernorate: data[i][6],
          targetInterests: data[i][7],
          image: data[i][14],
          actionUrl: data[i][15]
        };
        break;
      }
    }
    
    if (!notification) {
      return { success: false, error: 'Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯' };
    }
    
    // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø¬Ù…Ù‡ÙˆØ± Ø§Ù„Ù…Ø³ØªÙ‡Ø¯Ù
    let filters = {};
    if (notification.targetGovernorate) {
      filters.governorate = notification.targetGovernorate;
    }
    if (notification.targetInterests) {
      filters.interest = notification.targetInterests;
    }
    
    const targetUsers = getSubscribedUsers(filters);
    
    if (targetUsers.length === 0) {
      // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±
      sheet.getRange(notificationRow, 10).setValue('no_targets');
      return { 
        success: false, 
        message: 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ù…Ø³ØªÙ‡Ø¯ÙÙŠÙ†',
        targetCount: 0
      };
    }
    
    let successCount = 0;
    let failureCount = 0;
    
    // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
    targetUsers.forEach(user => {
      const personalizedNotification = {
        title: personalizeMessage(notification.title, user),
        body: personalizeMessage(notification.body, user),
        image: notification.image,
        actionUrl: notification.actionUrl
      };
      
      const success = sendSingleNotification(user, personalizedNotification);
      
      if (success) {
        successCount++;
        updateLastNotificationForUser(user.id);
      } else {
        failureCount++;
      }
    });
    
    // ØªØ­Ø¯ÙŠØ« Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±
    const successRate = targetUsers.length > 0 ? 
      ((successCount / targetUsers.length) * 100).toFixed(2) + '%' : '0%';
    
    sheet.getRange(notificationRow, 10).setValue('sent'); // Ø§Ù„Ø­Ø§Ù„Ø©
    sheet.getRange(notificationRow, 11).setValue(successCount); // Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø±Ø³Ù„ Ø¥Ù„ÙŠÙ‡Ù…
    sheet.getRange(notificationRow, 12).setValue(successRate); // Ù…Ø¹Ø¯Ù„ Ø§Ù„Ù†Ø¬Ø§Ø­
    
    console.log(`ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± ${notificationId}: ${successCount}/${targetUsers.length} Ù†Ø¬Ø­`);
    
    // ØªØ³Ø¬ÙŠÙ„ ÙÙŠ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
    trackNotificationStats(notificationId, notification.type, targetUsers.length, successCount);
    
    return { 
      success: true, 
      notificationId: notificationId,
      sent: successCount, 
      failed: failureCount,
      total: targetUsers.length,
      successRate: successRate,
      message: `ØªÙ… Ø¥Ø±Ø³Ø§Ù„ ${successCount} Ù…Ù† ${targetUsers.length} Ø¥Ø´Ø¹Ø§Ø±`
    };
    
  } catch (error) {
    console.error('Ø®Ø·Ø£ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±:', error);
    return { 
      success: false, 
      error: error.toString(),
      message: 'ÙØ´Ù„ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±'
    };
  }
}

function sendSingleNotification(user, notification) {
  // Ø¥Ø°Ø§ ÙƒØ§Ù† Firebase Ù…Ø¹Ø·Ù„ØŒ Ù…Ø­Ø§ÙƒØ§Ø© Ø§Ù„Ø¥Ø±Ø³Ø§Ù„
  if (!SYSTEM_CONFIG.FIREBASE_ENABLED) {
    console.log(`Ù…Ø­Ø§ÙƒØ§Ø© Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… ${user.name}: "${notification.title}"`);
    return true; // Ù…Ø­Ø§ÙƒØ§Ø© Ù†Ø¬Ø§Ø­ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„
  }
  
  try {
    const payload = {
      to: user.firebaseToken,
      notification: {
        title: notification.title,
        body: notification.body,
        icon: SYSTEM_CONFIG.NOTIFICATION_ICON,
        image: notification.image || '',
        click_action: notification.actionUrl || SYSTEM_CONFIG.APP_URL
      },
      data: {
        userId: user.id,
        type: 'custom_notification',
        timestamp: new Date().toISOString(),
        actionUrl: notification.actionUrl || SYSTEM_CONFIG.APP_URL
      }
    };
    
    const options = {
      method: 'POST',
      headers: {
        'Authorization': 'key=' + SYSTEM_CONFIG.FIREBASE_SERVER_KEY,
        'Content-Type': 'application/json'
      },
      payload: JSON.stringify(payload)
    };
    
    const response = UrlFetchApp.fetch(SYSTEM_CONFIG.FCM_ENDPOINT, options);
    const result = JSON.parse(response.getContentText());
    
    return result.success === 1;
    
  } catch (error) {
    console.error('Ø®Ø·Ø£ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„ÙØ±Ø¯ÙŠ:', error);
    return false;
  }
}

function updateLastNotificationForUser(userId) {
  try {
    const sheet = getSheet(SYSTEM_CONFIG.SHEETS.SUBSCRIPTIONS);
    const data = sheet.getDataRange().getValues();
    
    for (let i = 1; i < data.length; i++) {
      if (data[i][1] === userId) {
        sheet.getRange(i + 1, 11).setValue(new Date().toISOString());
        break;
      }
    }
  } catch (error) {
    console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø¢Ø®Ø± Ø¥Ø´Ø¹Ø§Ø±:', error);
  }
}

// ===== 5. Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ù…Ø¬Ø¯ÙˆÙ„Ø© ÙˆØ§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠØ© =====

function scheduleWelcomeNotification(userData) {
  const notificationData = {
    title: `ğŸ‰ Ù…Ø±Ø­Ø¨Ø§Ù‹ ${userData.name.split(' ')[0]}!`,
    body: `Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ø´ÙŠ Ø§Ù† Ø§Ù„Ø¹Ø±Ø§Ù‚! Ø§Ø³ØªÙ…ØªØ¹ Ø¨Ø§Ù„ØªØ³ÙˆÙ‚ Ù…Ù† ${userData.governorate}`,
    type: 'welcome',
    audience: 'user_specific',
    targetGovernorate: userData.governorate,
    creator: 'system_welcome',
    scheduledTime: 'now'
  };
  
  return createNotification(notificationData);
}

function scheduleOrderNotification(orderId, orderData) {
  const notificationData = {
    title: 'ğŸ“¦ Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯ ÙˆØµÙ„!',
    body: `Ø·Ù„Ø¨ Ø±Ù‚Ù… ${orderId} Ù…Ù† ${orderData.userName} - ${orderData.governorate}`,
    type: 'new_order',
    audience: 'admin',
    creator: 'system_order',
    scheduledTime: 'now'
  };
  
  return createNotification(notificationData);
}

function sendDailyMorningNotification() {
  const notificationData = {
    title: 'â˜€ï¸ ØµØ¨Ø§Ø­ Ø§Ù„Ø®ÙŠØ± Ù…Ù† Ø´ÙŠ Ø§Ù† Ø§Ù„Ø¹Ø±Ø§Ù‚',
    body: 'ØµØ¨Ø§Ø­ Ø§Ù„Ø®ÙŠØ±! ØªØµÙØ­ Ø§Ù„Ø¹Ø±ÙˆØ¶ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ø§Ù„ÙŠÙˆÙ… ÙˆØ§Ø³ØªÙ…ØªØ¹ Ø¨Ø§Ù„ØªØ³ÙˆÙ‚',
    type: 'daily_morning',
    audience: 'all',
    creator: 'system_daily',
    scheduledTime: 'now'
  };
  
  return createNotification(notificationData);
}

function sendDailyEveningNotification() {
  const notificationData = {
    title: 'ğŸŒ† Ø¹Ø±ÙˆØ¶ Ù…Ø³Ø§Ø¦ÙŠØ© Ø®Ø§ØµØ©',
    body: 'Ù…Ø³Ø§Ø¡ Ø§Ù„Ø®ÙŠØ±! Ø®ØµÙˆÙ…Ø§Øª Ø­ØµØ±ÙŠØ© ÙˆØ¹Ø±ÙˆØ¶ Ù…Ø³Ø§Ø¦ÙŠØ© Ù„Ø§ ØªÙÙˆØª',
    type: 'daily_evening',
    audience: 'all',
    creator: 'system_daily',
    scheduledTime: 'now'
  };
  
  return createNotification(notificationData);
}

function sendWeeklyNotification() {
  const notificationData = {
    title: 'ğŸ‰ Ø¹Ø±ÙˆØ¶ Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹',
    body: 'Ø§Ø³ØªØ¹Ø¯ Ù„Ø¹Ø·Ù„Ø© Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ Ù…Ø¹ Ù…Ø¬Ù…ÙˆØ¹Ø© Ø®Ø§ØµØ© Ù…Ù† Ø§Ù„Ø¹Ø±ÙˆØ¶',
    type: 'weekly_special',
    audience: 'all',
    creator: 'system_weekly',
    scheduledTime: 'now'
  };
  
  return createNotification(notificationData);
}

// Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø­Ø³Ø¨ Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø©
function sendGovernorateSpecialNotification(governorate, title, body) {
  const notificationData = {
    title: title || `ğŸ›ï¸ Ø¹Ø±Ø¶ Ø®Ø§Øµ Ù„Ø³ÙƒØ§Ù† ${governorate}`,
    body: body || `Ø¹Ø±Ø¶ Ø­ØµØ±ÙŠ ÙˆØ®ØµÙˆÙ…Ø§Øª Ù…Ù…ÙŠØ²Ø© Ù„Ø³ÙƒØ§Ù† ${governorate}`,
    type: 'governorate_special',
    audience: 'governorate',
    targetGovernorate: governorate,
    creator: 'system_governorate',
    scheduledTime: 'now'
  };
  
  return createNotification(notificationData);
}

// Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø­Ø³Ø¨ Ø§Ù„Ø§Ù‡ØªÙ…Ø§Ù…Ø§Øª
function sendInterestBasedNotification(interest, title, body) {
  const notificationData = {
    title: title || `âœ¨ Ù…Ù†ØªØ¬Ø§Øª Ø¬Ø¯ÙŠØ¯Ø© ÙÙŠ ${interest}`,
    body: body || `ØªØµÙØ­ Ø£Ø­Ø¯Ø« Ù…Ø¬Ù…ÙˆØ¹Ø© Ù…Ù† ${interest} Ø¨Ø£ÙØ¶Ù„ Ø§Ù„Ø£Ø³Ø¹Ø§Ø±`,
    type: 'interest_based',
    audience: 'interest',
    targetInterests: interest,
    creator: 'system_interest',
    scheduledTime: 'now'
  };
  
  return createNotification(notificationData);
}

// ===== 6. Ø§Ù„ØªØ­Ù„ÙŠÙ„Ø§Øª ÙˆØ§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…ÙØ­Ø¯Ø«Ø© =====

function trackUserEvent(userId, eventType, eventDetails = {}, governorate = '') {
  try {
    const sheet = getSheet(SYSTEM_CONFIG.SHEETS.ANALYTICS);
    
    const rowData = [
      new Date(),
      eventType,
      userId,
      JSON.stringify(eventDetails),
      'web_app',
      JSON.stringify({
        timestamp: new Date().toISOString(),
        userAgent: eventDetails.userAgent || 'unknown'
      }),
      governorate,
      eventDetails.device || 'web'
    ];
    
    sheet.appendRow(rowData);
    console.log(`ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø­Ø¯Ø«: ${eventType} Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… ${userId}`);
    
  } catch (error) {
    console.error('Ø®Ø·Ø£ ÙÙŠ ØªØªØ¨Ø¹ Ø§Ù„Ø­Ø¯Ø«:', error);
  }
}

function trackNotificationStats(notificationId, type, targetCount, successCount) {
  try {
    trackUserEvent('system', 'notification_sent', {
      notificationId: notificationId,
      type: type,
      targetCount: targetCount,
      successCount: successCount,
      successRate: targetCount > 0 ? ((successCount / targetCount) * 100).toFixed(2) + '%' : '0%'
    });
  } catch (error) {
    console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª:', error);
  }
}

function getSystemStats() {
  try {
    const users = getAllActiveUsers();
    const subscribers = getSubscribedUsers();
    
    // Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø§Øª
    const governorateStats = {};
    const interestStats = {};
    
    users.forEach(user => {
      governorateStats[user.governorate] = (governorateStats[user.governorate] || 0) + 1;
      
      user.interests.forEach(interest => {
        if (interest.trim()) {
          interestStats[interest.trim()] = (interestStats[interest.trim()] || 0) + 1;
        }
      });
    });
    
    // Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø·Ù„Ø¨Ø§Øª
    const ordersSheet = getSheet(SYSTEM_CONFIG.SHEETS.ORDERS);
    const ordersData = ordersSheet.getDataRange().getValues();
    const totalOrders = ordersData.length - 1; // -1 Ù„Ù„Ø¹Ù†Ø§ÙˆÙŠÙ†
    
    let totalRevenue = 0;
    for (let i = 1; i < ordersData.length; i++) {
      totalRevenue += parseFloat(ordersData[i][10]) || 0; // Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ÙƒÙ„ÙŠ
    }
    
    // Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
    const notificationsSheet = getSheet(SYSTEM_CONFIG.SHEETS.NOTIFICATIONS);
    const notificationsData = notificationsSheet.getDataRange().getValues();
    const totalNotifications = notificationsData.length - 1;
    
    return {
      success: true,
      users: {
        total: users.length,
        subscribers: subscribers.length,
        byGovernorate: governorateStats,
        byInterest: interestStats
      },
      orders: {
        total: totalOrders,
        totalRevenue: Math.round(totalRevenue),
        averageOrder: totalOrders > 0 ? Math.round(totalRevenue / totalOrders) : 0
      },
      notifications: {
        total: totalNotifications,
        sent: notificationsData.filter(row => row[9] === 'sent').length - 1
      },
      topGovernorates: Object.entries(governorateStats)
        .sort(([,a], [,b]) => b - a)
        .slice(0, 5),
      topInterests: Object.entries(interestStats)
        .sort(([,a], [,b]) => b - a)
        .slice(0, 5),
      timestamp: new Date().toISOString()
    };
  } catch (error) {
    console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª:', error);
    return {
      success: false,
      error: error.toString(),
      timestamp: new Date().toISOString()
    };
  }
}

// ===== 7. Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ù…Ù† ÙˆØ±Ù‚Ø© Notifications =====

function getNotificationsFromSheet() {
  try {
    const sheet = getSheet(SYSTEM_CONFIG.SHEETS.NOTIFICATIONS);
    const data = sheet.getDataRange().getValues();
    const notifications = [];
    
    for (let i = 1; i < data.length; i++) {
      const row = data[i];
      notifications.push({
        id: row[1],
        title: row[2],
        body: row[3],
        type: row[4],
        audience: row[5],
        targetGovernorate: row[6],
        targetInterests: row[7],
        scheduledTime: row[8],
        status: row[9],
        sentCount: row[10],
        successRate: row[11],
        createdAt: row[12],
        creator: row[13],
        image: row[14],
        actionUrl: row[15]
      });
    }
    
    return { success: true, notifications: notifications };
  } catch (error) {
    console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª:', error);
    return { success: false, error: error.toString() };
  }
}

function sendPendingNotifications() {
  try {
    const sheet = getSheet(SYSTEM_CONFIG.SHEETS.NOTIFICATIONS);
    const data = sheet.getDataRange().getValues();
    let sentCount = 0;
    
    for (let i = 1; i < data.length; i++) {
      const row = data[i];
      const status = row[9];
      const scheduledTime = row[8];
      const notificationId = row[1];
      
      if (status === 'created' && (!scheduledTime || scheduledTime === 'now')) {
        const result = sendNotificationById(notificationId);
        if (result.success) {
          sentCount++;
        }
      }
    }
    
    return { 
      success: true, 
      message: `ØªÙ… Ø¥Ø±Ø³Ø§Ù„ ${sentCount} Ø¥Ø´Ø¹Ø§Ø± Ù…Ø¹Ù„Ù‚`,
      sentCount: sentCount
    };
  } catch (error) {
    console.error('Ø®Ø·Ø£ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ù…Ø¹Ù„Ù‚Ø©:', error);
    return { success: false, error: error.toString() };
  }
}

// ===== 7.5 Ø¥Ø¯Ø§Ø±Ø© ØµÙˆØ± Ø§Ù„ÙØ¦Ø§Øª =====

// ===== Ø¯Ø§Ù„Ø© Ø¬Ù„Ø¨ ØµÙˆØ± Ø§Ù„ÙØ¦Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© =====
function getCategoryImage(requestData) {
  try {
    const { sheetId, sheetName, imageCol } = requestData;
    
    console.log('ğŸ–¼ï¸ Ø·Ù„Ø¨ ØµÙˆØ±Ø© Ù„Ù„ÙØ¦Ø©:', sheetName, 'Ù…Ù† Ø§Ù„Ø¬Ø¯ÙˆÙ„:', sheetId);
    
    const spreadsheet = SpreadsheetApp.openById(sheetId);
    const sheet = spreadsheet.getSheetByName(sheetName);
    
    if (!sheet) {
      console.log('âŒ Ø§Ù„ÙˆØ±Ù‚Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©:', sheetName);
      return { success: false, error: 'Ø§Ù„ÙˆØ±Ù‚Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©' };
    }
    
    // ØªØ­Ø¯ÙŠØ¯ ÙÙ‡Ø±Ø³ Ø§Ù„Ø¹Ù…ÙˆØ¯ (F=6, G=7, etc.)
    const imageColIndex = imageCol.charCodeAt(0) - 64; // A=1, B=2, etc.
    console.log('ğŸ” Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø¹Ù…ÙˆØ¯:', imageCol, 'ÙÙ‡Ø±Ø³:', imageColIndex);
    
    // Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ø¹Ù…ÙˆØ¯ Ø§Ù„Ù…Ø­Ø¯Ø¯ (Ù…Ù† Ø§Ù„ØµÙ 2 Ø¥Ù„Ù‰ 50)
    const range = sheet.getRange(2, imageColIndex, 49, 1);
    const values = range.getValues();
    
    console.log('ğŸ“Š ØªÙ… Ø¬Ù„Ø¨', values.length, 'ØµÙ Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
    
    // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† ØµÙˆØ±Ø© ØµØ§Ù„Ø­Ø©
    for (let i = 0; i < values.length; i++) {
      const cellValue = values[i][0];
      
      if (cellValue && cellValue.toString().trim() !== '') {
        const imageUrl = cellValue.toString().trim();
        
        console.log('ğŸ” ÙØ­Øµ Ø§Ù„ØµÙ', i + 2, ':', imageUrl.substring(0, 50) + '...');
        
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø±Ø§Ø¨Ø· Ø§Ù„ØµÙˆØ±Ø©
        if (imageUrl.includes('http') && 
            (imageUrl.includes('.jpg') || 
             imageUrl.includes('.jpeg') || 
             imageUrl.includes('.png') || 
             imageUrl.includes('.webp') ||
             imageUrl.includes('drive.google.com') ||
             imageUrl.includes('googleusercontent.com'))) {
          
          console.log('âœ… ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ØµÙˆØ±Ø© ØµØ§Ù„Ø­Ø©:', imageUrl);
          
          // ØªØ­ÙˆÙŠÙ„ Ø±Ø§Ø¨Ø· Google Drive Ø¥Ù„Ù‰ Ø±Ø§Ø¨Ø· Ù…Ø¨Ø§Ø´Ø±
          if (imageUrl.includes('drive.google.com')) {
            const fileIdMatch = imageUrl.match(/\/d\/([a-zA-Z0-9_-]+)/);
            if (fileIdMatch) {
              const directUrl = `https://drive.google.com/uc?export=view&id=${fileIdMatch[1]}`;
              console.log('ğŸ”„ ØªÙ… ØªØ­ÙˆÙŠÙ„ Ø±Ø§Ø¨Ø· Google Drive:', directUrl);
              return { 
                success: true, 
                imageUrl: directUrl,
                originalUrl: imageUrl,
                rowNumber: i + 2
              };
            }
          }
          
          return { 
            success: true, 
            imageUrl: imageUrl,
            rowNumber: i + 2
          };
        }
      }
    }
    
    console.log('âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ØµÙˆØ±Ø© ØµØ§Ù„Ø­Ø© ÙÙŠ', sheetName);
    return { 
      success: false, 
      error: 'Ù„Ø§ ØªÙˆØ¬Ø¯ ØµÙˆØ±Ø© ØµØ§Ù„Ø­Ø©',
      searchedRows: values.length
    };
    
  } catch (error) {
    console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ ØµÙˆØ±Ø© Ø§Ù„ÙØ¦Ø©:', error);
    return { 
      success: false, 
      error: error.toString(),
      message: 'ÙØ´Ù„ ÙÙŠ Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ø¨ÙŠØ§Ù†Ø§Øª'
    };
  }
}

// ===== 8. ÙˆØ¸Ø§Ø¦Ù Ù…Ø³Ø§Ø¹Ø¯Ø© =====

function personalizeMessage(message, user) {
  try {
    const userName = user.name ? user.name.split(' ')[0] : 'Ø¹Ø²ÙŠØ²ÙŠ Ø§Ù„Ø¹Ù…ÙŠÙ„';
    const userGov = user.governorate || 'Ø§Ù„Ø¹Ø±Ø§Ù‚';
    
    return message
      .replace(/\{name\}/g, userName)
      .replace(/\{governorate\}/g, userGov)
      .replace(/\{first_name\}/g, userName);
  } catch (error) {
    console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ®ØµÙŠØµ Ø§Ù„Ø±Ø³Ø§Ù„Ø©:', error);
    return message;
  }
}

function getSystemStatus() {
  try {
    const users = getAllActiveUsers();
    const subscribers = getSubscribedUsers();
    
    return {
      success: true,
      status: 'running',
      version: SYSTEM_CONFIG.SYSTEM_VERSION,
      lastUpdated: SYSTEM_CONFIG.LAST_UPDATED,
      sheets: {
        id: SYSTEM_CONFIG.MAIN_SHEET_ID,
        status: 'connected'
      },
      firebase: {
        enabled: SYSTEM_CONFIG.FIREBASE_ENABLED,
        status: SYSTEM_CONFIG.FIREBASE_ENABLED ? 'ready' : 'disabled'
      },
      users: {
        total: users.length,
        subscribers: subscribers.length
      },
      webApp: {
        url: SYSTEM_CONFIG.WEB_APP_URL,
        status: 'deployed'
      },
      timestamp: new Date().toISOString()
    };
  } catch (error) {
    return {
      success: false,
      status: 'error',
      error: error.toString(),
      timestamp: new Date().toISOString()
    };
  }
}

// ===== 9. Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù…Ø­ÙØ²Ø§Øª Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠØ© =====

function setupAllTriggers() {
  try {
    // Ø­Ø°Ù Ø§Ù„Ù…Ø­ÙØ²Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
    const triggers = ScriptApp.getProjectTriggers();
    triggers.forEach(trigger => {
      const functionName = trigger.getHandlerFunction();
      if (functionName.includes('Daily') || functionName.includes('Weekly') || functionName.includes('Notification')) {
        ScriptApp.deleteTrigger(trigger);
      }
    });
    
    // Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø­ÙØ²Ø§Øª Ø¬Ø¯ÙŠØ¯Ø©
    ScriptApp.newTrigger('sendDailyMorningNotification')
      .timeBased()
      .everyDays(1)
      .atHour(9)
      .create();
    
    ScriptApp.newTrigger('sendDailyEveningNotification')
      .timeBased()
      .everyDays(1)
      .atHour(18)
      .create();
    
    ScriptApp.newTrigger('sendWeeklyNotification')
      .timeBased()
      .onWeekDay(ScriptApp.WeekDay.THURSDAY)
      .atHour(18)
      .create();
    
    // Ù…Ø­ÙØ² Ù„Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ù…Ø¹Ù„Ù‚Ø© ÙƒÙ„ Ø³Ø§Ø¹Ø©
    ScriptApp.newTrigger('sendPendingNotifications')
      .timeBased()
      .everyHours(1)
      .create();
    
    console.log('ØªÙ… Ø¥Ø¹Ø¯Ø§Ø¯ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø­ÙØ²Ø§Øª Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠØ©');
    return { success: true, message: 'ØªÙ… Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù…Ø­ÙØ²Ø§Øª Ø¨Ù†Ø¬Ø§Ø­' };
    
  } catch (error) {
    console.error('Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù…Ø­ÙØ²Ø§Øª:', error);
    return { success: false, error: error.toString() };
  }
}

// ===== 10. Web App API Endpoints =====

function doPost(e) {
  try {
    if (!e.postData || !e.postData.contents) {
      return ContentService
        .createTextOutput(JSON.stringify({ 
          success: false, 
          error: 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ø§Ù„Ø·Ù„Ø¨',
          timestamp: new Date().toISOString()
        }))
        .setMimeType(ContentService.MimeType.JSON);
    }
    
    const data = JSON.parse(e.postData.contents);
    const action = data.action;
    
    console.log(`ğŸ“¨ Web App API: ${action} ÙÙŠ ${new Date().toISOString()}`);
    
    let result;
    
    switch (action) {
      // === Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† ===
      case 'save_user':
        result = saveUserData(data.userData);
        break;
        
      case 'get_user':
        result = { 
          success: true, 
          user: getUserById(data.userId)
        };
        break;
        
      // === Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª ===
      case 'save_order':
        result = saveOrderData(data.orderData);
        break;
        
      // === Ø¬Ù„Ø¨ ØµÙˆØ± Ø§Ù„ÙØ¦Ø§Øª - Ø¬Ø¯ÙŠØ¯ ===
      case 'get_category_image':
        result = getCategoryImage(data);
        break;
        
      // === Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª ===
      case 'create_notification':
        result = createNotification(data.notificationData);
        break;
        
      case 'send_notification':
        result = sendNotificationById(data.notificationId);
        break;
        
      case 'get_notifications':
        result = getNotificationsFromSheet();
        break;
        
      case 'send_pending_notifications':
        result = sendPendingNotifications();
        break;
        
      // === Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø®Ø§ØµØ© ===
      case 'send_governorate_notification':
        result = sendGovernorateSpecialNotification(
          data.governorate, 
          data.title, 
          data.body
        );
        break;
        
      case 'send_interest_notification':
        result = sendInterestBasedNotification(
          data.interest, 
          data.title, 
          data.body
        );
        break;
        
      // === Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª ===
      case 'get_stats':
        result = getSystemStats();
        break;
        
      case 'get_system_status':
        result = getSystemStatus();
        break;
        
      // === Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù… ===
      case 'setup_triggers':
        result = setupAllTriggers();
        break;
        
      // === Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø§ØªØµØ§Ù„ ===
      case 'test_connection':
        result = { 
          success: true, 
          message: 'âœ… Ø§Ù„Ø§ØªØµØ§Ù„ Ù†Ø§Ø¬Ø­ Ù…Ø¹ Google Apps Script',
          timestamp: new Date().toISOString(),
          version: SYSTEM_CONFIG.SYSTEM_VERSION,
          firebase: SYSTEM_CONFIG.FIREBASE_ENABLED ? 'enabled' : 'disabled',
          sheets: SYSTEM_CONFIG.MAIN_SHEET_ID
        };
        break;
        
      default:
        result = { 
          success: false, 
          error: `Ø¥Ø¬Ø±Ø§Ø¡ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ: ${action}`,
          availableActions: [
            'save_user', 'get_user', 'save_order', 'get_category_image',
            'create_notification', 'send_notification', 'get_notifications',
            'send_governorate_notification', 'send_interest_notification',
            'get_stats', 'test_connection', 'setup_triggers'
          ]
        };
    }
    
    result.timestamp = result.timestamp || new Date().toISOString();
    result.action = action;
    result.version = SYSTEM_CONFIG.SYSTEM_VERSION;
    
    console.log(`âœ… Ù…Ø¹Ø§Ù„Ø¬Ø© ${action}: ${result.success ? 'Ù†Ø¬Ø­' : 'ÙØ´Ù„'}`);
    
    return ContentService
      .createTextOutput(JSON.stringify(result))
      .setMimeType(ContentService.MimeType.JSON);
    
  } catch (error) {
    console.error('âŒ Ø®Ø·Ø£ ÙÙŠ doPost:', error);
    return ContentService
      .createTextOutput(JSON.stringify({ 
        success: false, 
        error: error.toString(),
        message: 'Ø®Ø·Ø£ ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø·Ù„Ø¨',
        timestamp: new Date().toISOString()
      }))
      .setMimeType(ContentService.MimeType.JSON);
  }
}

function doGet(e) {
  const params = e.parameter;
  
  if (params.action === 'status') {
    return ContentService
      .createTextOutput(JSON.stringify(getSystemStatus()))
      .setMimeType(ContentService.MimeType.JSON);
  }
  
  if (params.action === 'stats') {
    return ContentService
      .createTextOutput(JSON.stringify(getSystemStats()))
      .setMimeType(ContentService.MimeType.JSON);
  }
  
  return ContentService
    .createTextOutput(JSON.stringify({
      success: true,
      message: 'SHIQ Backend API v' + SYSTEM_CONFIG.SYSTEM_VERSION,
      timestamp: new Date().toISOString(),
      firebase: SYSTEM_CONFIG.FIREBASE_ENABLED ? 'enabled' : 'disabled',
      sheets: {
        id: SYSTEM_CONFIG.MAIN_SHEET_ID,
        worksheets: Object.values(SYSTEM_CONFIG.SHEETS)
      },
      endpoints: {
        POST: 'Ø¬Ù…ÙŠØ¹ Ø¹Ù…Ù„ÙŠØ§Øª Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª',
        GET: 'Ø§Ù„Ø§Ø³ØªØ¹Ù„Ø§Ù…Ø§Øª ÙˆØ­Ø§Ù„Ø© Ø§Ù„Ù†Ø¸Ø§Ù…'
      }
    }))
    .setMimeType(ContentService.MimeType.JSON);
}

// ===== 11. ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø© =====

function testCompleteSystem() {
  console.log('ğŸš€ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù…ØªÙƒØ§Ù…Ù„ Ø§Ù„ÙƒØ§Ù…Ù„ v2.1');
  console.log('===========================================');
  
  const results = {};
  
  // Ø§Ø®ØªØ¨Ø§Ø± 1: Ø§Ù„Ø§ØªØµØ§Ù„ ÙˆØ§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
  console.log('1ï¸âƒ£ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø§ØªØµØ§Ù„...');
  try {
    const spreadsheet = SpreadsheetApp.openById(SYSTEM_CONFIG.MAIN_SHEET_ID);
    console.log('âœ… Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ Google Sheets ÙŠØ¹Ù…Ù„');
    console.log('ğŸ“Š Ù…Ø¹Ø±Ù Ø§Ù„Ø¬Ø¯ÙˆÙ„:', SYSTEM_CONFIG.MAIN_SHEET_ID);
    console.log('ğŸ“‹ Ø£ÙˆØ±Ø§Ù‚ Ø§Ù„Ø¹Ù…Ù„:', Object.values(SYSTEM_CONFIG.SHEETS));
    results.connection = true;
  } catch (error) {
    console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„:', error);
    results.connection = false;
  }
  
  // Ø§Ø®ØªØ¨Ø§Ø± 2: Ø£ÙˆØ±Ø§Ù‚ Ø§Ù„Ø¹Ù…Ù„
  console.log('2ï¸âƒ£ Ø§Ø®ØªØ¨Ø§Ø± Ø£ÙˆØ±Ø§Ù‚ Ø§Ù„Ø¹Ù…Ù„...');
  try {
    Object.values(SYSTEM_CONFIG.SHEETS).forEach(sheetName => {
      const sheet = getSheet(sheetName);
      console.log(`âœ… ÙˆØ±Ù‚Ø© ${sheetName} Ø¬Ø§Ù‡Ø²Ø©`);
    });
    results.sheets = true;
  } catch (error) {
    console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø£ÙˆØ±Ø§Ù‚ Ø§Ù„Ø¹Ù…Ù„:', error);
    results.sheets = false;
  }
  
  // Ø§Ø®ØªØ¨Ø§Ø± 3: Ø­ÙØ¸ Ù…Ø³ØªØ®Ø¯Ù… ØªØ¬Ø±ÙŠØ¨ÙŠ
  console.log('3ï¸âƒ£ Ø§Ø®ØªØ¨Ø§Ø± Ø­ÙØ¸ Ù…Ø³ØªØ®Ø¯Ù…...');
  const testUser = {
    id: 'test_v2_' + Date.now(),
    name: 'Ø£Ø­Ù…Ø¯ Ø§Ù„ØªØ¬Ø±ÙŠØ¨ÙŠ v2.1',
    phone: '07901234567',
    governorate: 'Ø¨ØºØ¯Ø§Ø¯',
    address: 'Ø´Ø§Ø±Ø¹ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù…ØªÙ‚Ø¯Ù…',
    interests: ['Ù…Ù„Ø§Ø¨Ø³ Ù†Ø³Ø§Ø¦ÙŠØ©', 'Ø§ÙƒØ³Ø³ÙˆØ§Ø±Ø§Øª Ù†Ø³Ø§Ø¦ÙŠØ©'],
    notificationsEnabled: true,
    registrationDate: new Date().toISOString()
  };
  
  const userResult = saveUserData(testUser);
  console.log('Ù†ØªÙŠØ¬Ø© Ø­ÙØ¸ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:', userResult);
  results.userSave = userResult.success;
  
  // Ø§Ø®ØªØ¨Ø§Ø± 4: Ø­ÙØ¸ Ø·Ù„Ø¨ ØªØ¬Ø±ÙŠØ¨ÙŠ
  console.log('4ï¸âƒ£ Ø§Ø®ØªØ¨Ø§Ø± Ø­ÙØ¸ Ø·Ù„Ø¨...');
  const testOrder = {
    userId: testUser.id,
    userName: testUser.name,
    userPhone: testUser.phone,
    governorate: testUser.governorate,
    products: [
      { name: 'Ù…Ù†ØªØ¬ ØªØ¬Ø±ÙŠØ¨ÙŠ 1', price: 15000 },
      { name: 'Ù…Ù†ØªØ¬ ØªØ¬Ø±ÙŠØ¨ÙŠ 2', price: 25000 }
    ],
    subtotal: 40000,
    deliveryFee: 5000,
    total: 45000,
    status: 'test_v2'
  };
  
  const orderResult = saveOrderData(testOrder);
  console.log('Ù†ØªÙŠØ¬Ø© Ø­ÙØ¸ Ø§Ù„Ø·Ù„Ø¨:', orderResult);
  results.orderSave = orderResult.success;
  
  // Ø§Ø®ØªØ¨Ø§Ø± 5: Ø¥Ù†Ø´Ø§Ø¡ Ø¥Ø´Ø¹Ø§Ø±
  console.log('5ï¸âƒ£ Ø§Ø®ØªØ¨Ø§Ø± Ø¥Ù†Ø´Ø§Ø¡ Ø¥Ø´Ø¹Ø§Ø±...');
  const testNotification = {
    title: 'ğŸ§ª Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù†Ø¸Ø§Ù… v2.1',
    body: 'Ø¥Ø´Ø¹Ø§Ø± ØªØ¬Ø±ÙŠØ¨ÙŠ Ù…Ù† Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù…ØªÙƒØ§Ù…Ù„ Ø§Ù„Ø¬Ø¯ÙŠØ¯',
    type: 'system_test',
    audience: 'all',
    creator: 'test_system'
  };
  
  const notificationResult = createNotification(testNotification);
  console.log('Ù†ØªÙŠØ¬Ø© Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±:', notificationResult);
  results.notification = notificationResult.success;
  
  // Ø§Ø®ØªØ¨Ø§Ø± 6: Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
  console.log('6ï¸âƒ£ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª...');
  const statsResult = getSystemStats();
  console.log('Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù†Ø¸Ø§Ù…:', statsResult);
  results.stats = statsResult.success;
  
  console.log('===========================================');
  
  const allTestsPassed = Object.values(results).every(result => result === true);
  
  if (allTestsPassed) {
    console.log('ğŸ‰ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ù†Ø¬Ø­Øª! Ø§Ù„Ù†Ø¸Ø§Ù… v2.1 Ø¬Ø§Ù‡Ø² Ù„Ù„Ø¹Ù…Ù„');
  } else {
    console.log('âš ï¸ Ø¨Ø¹Ø¶ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª ÙˆØ§Ø¬Ù‡Øª Ù…Ø´Ø§ÙƒÙ„');
  }
  
  console.log('ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù†ØªØ§Ø¦Ø¬:', results);
  
  return {
    success: allTestsPassed,
    results: results,
    version: SYSTEM_CONFIG.SYSTEM_VERSION,
    timestamp: new Date().toISOString()
  };
}

// ===== Ø¯ÙˆØ§Ù„ Ø§Ù„ØªÙ‡ÙŠØ¦Ø© =====

function initializeCompleteSystem() {
  console.log('ğŸš€ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù…ØªÙƒØ§Ù…Ù„ Ø§Ù„ÙƒØ§Ù…Ù„...');
  console.log('Ø§Ù„Ù†Ø³Ø®Ø©:', SYSTEM_CONFIG.SYSTEM_VERSION);
  console.log('Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«:', SYSTEM_CONFIG.LAST_UPDATED);
  console.log('Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:', SYSTEM_CONFIG.MAIN_SHEET_ID);
  console.log('Ø£ÙˆØ±Ø§Ù‚ Ø§Ù„Ø¹Ù…Ù„:', Object.values(SYSTEM_CONFIG.SHEETS));
  console.log('Firebase:', SYSTEM_CONFIG.FIREBASE_ENABLED ? 'Ù…ÙØ¹Ù„' : 'Ù…Ø¹Ø·Ù„ Ù…Ø¤Ù‚ØªØ§Ù‹');
  console.log('âœ… Ø§Ù„Ù†Ø¸Ø§Ù… Ø¬Ø§Ù‡Ø² Ù„Ù„Ø¹Ù…Ù„!');
  
  return getSystemStatus();
}

// ===== ØªØ³Ø¬ÙŠÙ„ Ø¨Ø¯Ø§ÙŠØ© ØªØ´ØºÙŠÙ„ Ø§Ù„Ù†Ø¸Ø§Ù… =====
console.log('ğŸ¯ ØªÙ… ØªØ­Ù…ÙŠÙ„ Google Apps Script Ù„Ø´ÙŠ Ø§Ù† Ø§Ù„Ø¹Ø±Ø§Ù‚ v' + SYSTEM_CONFIG.SYSTEM_VERSION);
console.log('ğŸ”— Web App URL: ' + SYSTEM_CONFIG.WEB_APP_URL);
console.log('ğŸ“Š Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ' + SYSTEM_CONFIG.MAIN_SHEET_ID);
console.log('âœ… Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù…ØªÙƒØ§Ù…Ù„ Ø¬Ø§Ù‡Ø² Ù„Ù„Ø¹Ù…Ù„!');